<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>

<body>
	name<input id="name" type="text" /><br>
	<input id="text" type="text" />
	<button onclick="send()">傳送訊息</button>
	<hr />
	<!--
		<button onclick="closeWebSocket()">關閉WebSocket連線</button>
		<hr/>
		-->
	<div id="message"></div>
</body>
<script type="text/javascript">


	if (typeof (WebSocket) == "undefined") {
		alert('當前瀏覽器 Not support websocket');
	} else {
		//判斷當前瀏覽器是否支援WebSocket
		var url = window.location.href + 'api/websocket/100'
		
		if (url.indexOf("https") >= 0) {
			url = url.replace("https", "wss");
		} else {
			url = url.replace("http", "ws");
		}

		var lockReconnect = false;//避免重複連接
		var websocket;
		var tt;
		//創連接
		createWebSocket();
		function createWebSocket() {
			try {
				websocket = new WebSocket(url);
				init();
			} catch (e) {
				reconnect(url);
			}
		}

		/**
		 * 初始化链接
		 */
		function init() {
			websocket.onclose = function () {
				reconnect(url);
			};
			websocket.onerror = function () {
				reconnect(url);
				setMessageInnerHTML("WebSocket連線發生錯誤");
			};
			websocket.onopen = function () {
				// 心跳檢測重置
				heartCheck.start();
			};
			websocket.onmessage = function (event) {
				heartCheck.start();
				setMessageInnerHTML(event.data);
			}
			//監聽視窗關閉事件，當視窗關閉時，主動去關閉websocket連線，防止連線還沒斷開就關閉視窗，server端會拋異常。
			window.onbeforeunload = function() {
				websocket.send("1位訪客默默的離開");
				closeWebSocket();
			}

		}
		function setMessageInnerHTML(innerHTML) {
			document.getElementById('message').innerHTML += innerHTML + '<br/>';
		}

		//傳送訊息
		function send() {
			var name = document.getElementById('name').value;
			if(name==""){
				alert("請輸入name")
				return false;
			}
			var message = document.getElementById('text').value;
			if (message != "") {
				websocket.send(name+":"+message);
				document.getElementById('text').value = "";
			}
		}
		var lockReconnect = false;//避免重複連接
		//重新連接socket
		function reconnect(url) {
			if (lockReconnect) {
				return;
			};
			lockReconnect = true;
			//沒連上會一直重連
			tt && clearTimeout(tt);
			tt = setTimeout(function () {
				createWebSocket(url);
				lockReconnect = false;
			}, 180000);
		}
		//心跳檢測
		var heartCheck = {
			timeout: 210000,
			timeoutObj: null,
			serverTimeoutObj: null,
			start: function () {
				var self = this;
				this.timeoutObj && clearTimeout(this.timeoutObj);
				this.serverTimeoutObj && clearTimeout(this.serverTimeoutObj);
				this.timeoutObj = setTimeout(function () {
					//這裡發送一個心跳 後端收到後返回一個心跳消息
					//onmessage拿到返回的心跳說明連接正常
					console.log(getNowTime() + ' Socket 連接重試');
					websocket.send("連接成功");
					self.serverTimeoutObj = setTimeout(function () {
						console.log(websocket);
						websocket.close();
					}, self.timeout);
				}, this.timeout)
			}
		}
	}

	/**
	 * 獲取系統當前時間
	 * @returns
	 */
	function p(s) {
		return s < 10 ? '0' + s : s;
	}
	function getNowTime() {
		var myDate = new Date();
		var year = myDate.getFullYear();
		var month = myDate.getMonth() + 1;
		var date = myDate.getDate();
		var h = myDate.getHours();       //當前小時(0-23)
		var m = myDate.getMinutes();     //當前分鐘(0-59)
		var s = myDate.getSeconds();
		return year + '-' + p(month) + "-" + p(date) + " " + p(h) + ':' + p(m) + ":" + p(s);
	}

</script>

</html>